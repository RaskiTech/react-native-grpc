{"version":3,"sources":["client.ts"],"names":["Grpc","NativeModules","Emitter","NativeEventEmitter","createDeferred","signal","completed","deferred","promise","Promise","resolve","reject","value","reason","addEventListener","idCtr","deferredMap","handleGrpcEvent","event","id","type","headers","payload","data","notifyData","response","trailers","notifyComplete","error","GrpcError","code","noitfyError","getId","GrpcClient","constructor","addListener","destroy","removeAllListeners","getHost","setHost","host","getInsecure","getIsInsecure","setInsecure","insecure","setResponseSizeLimit","limitInBytes","unaryCall","method","requestHeaders","requestData","obj","abort","AbortController","cancelGrpcCall","call","GrpcUnaryCall","then","result","serverStreamCall","stream","ServerOutputStream","serverStreamingCall","GrpcServerStreamingCall"],"mappings":"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","sourcesContent":["import { AbortController, AbortSignal } from 'abort-controller';\nimport { fromByteArray, toByteArray } from 'base64-js';\nimport { NativeEventEmitter, NativeModules } from 'react-native';\nimport { GrpcError } from './errors';\nimport {\n  GrpcServerStreamingCall,\n  ServerOutputStream,\n} from './server-streaming';\nimport { GrpcMetadata } from './types';\nimport { GrpcUnaryCall } from './unary';\n\ntype GrpcRequestObject = {\n  data: string;\n};\n\ntype GrpcType = {\n  getHost: () => Promise<string>;\n  getIsInsecure: () => Promise<boolean>;\n  setHost(host: string): void;\n  setInsecure(insecure: boolean): void;\n  setResponseSizeLimit(limitInBytes: number): void;\n  unaryCall(\n    id: number,\n    path: string,\n    obj: GrpcRequestObject,\n    requestHeaders?: GrpcMetadata\n  ): Promise<void>;\n  serverStreamingCall(\n    id: number,\n    path: string,\n    obj: GrpcRequestObject,\n    requestHeaders?: GrpcMetadata\n  ): Promise<void>;\n  cancelGrpcCall: (id: number) => Promise<boolean>;\n  clientStreamingCall(\n    id: number,\n    path: string,\n    obj: GrpcRequestObject,\n    requestHeaders?: GrpcMetadata\n  ): Promise<void>;\n  finishClientStreaming(id: number): Promise<void>;\n};\n\ntype GrpcEventType = 'response' | 'error' | 'headers' | 'trailers';\n\n/* prettier-ignore */\ntype GrpcEventPayload =\n  {\n    type: 'response';\n    payload: string;\n  } | {\n    type: 'error';\n    error: string;\n    code?: number;\n    trailers?: GrpcMetadata;\n  } | {\n    type: 'headers';\n    payload: GrpcMetadata;\n  } | {\n    type: 'trailers';\n    payload: GrpcMetadata;\n  } | {\n    type: 'status';\n    payload: number;\n  };\n\ntype GrpcEvent = {\n  id: number;\n  type: GrpcEventType;\n} & GrpcEventPayload;\n\nconst { Grpc } = NativeModules as { Grpc: GrpcType };\n\nconst Emitter = new NativeEventEmitter(NativeModules.Grpc);\n\ntype Deferred<T> = {\n  promise: Promise<T>;\n  resolve: (value: T) => void;\n  reject: (reason: any) => void;\n};\n\ntype DeferredCalls = {\n  headers?: Deferred<GrpcMetadata>;\n  response?: Deferred<Uint8Array>;\n  trailers?: Deferred<GrpcMetadata>;\n  data?: ServerOutputStream;\n};\n\ntype DeferredCallMap = {\n  [id: number]: DeferredCalls;\n};\n\nfunction createDeferred<T>(signal: AbortSignal) {\n  let completed = false;\n\n  const deferred: Deferred<T> = {} as any;\n\n  deferred.promise = new Promise<T>((resolve, reject) => {\n    deferred.resolve = (value) => {\n      completed = true;\n\n      resolve(value);\n    };\n    deferred.reject = (reason) => {\n      completed = true;\n\n      reject(reason);\n    };\n  });\n\n  signal.addEventListener('abort', () => {\n    if (!completed) {\n      deferred.reject('aborted');\n    }\n  });\n\n  return deferred;\n}\n\nlet idCtr = 1;\n\nconst deferredMap: DeferredCallMap = {};\n\nfunction handleGrpcEvent(event: GrpcEvent) {\n  const deferred = deferredMap[event.id];\n\n  if (deferred) {\n    switch (event.type) {\n      case 'headers':\n        deferred.headers?.resolve(event.payload);\n        break;\n      case 'response':\n        const data = toByteArray(event.payload);\n\n        deferred.data?.notifyData(data);\n        deferred.response?.resolve(data);\n        break;\n      case 'trailers':\n        deferred.trailers?.resolve(event.payload);\n        deferred.data?.notifyComplete();\n\n        delete deferredMap[event.id];\n        break;\n      case 'error':\n        const error = new GrpcError(event.error, event.code, event.trailers);\n\n        deferred.headers?.reject(error);\n        deferred.trailers?.reject(error);\n        deferred.response?.reject(error);\n        deferred.data?.noitfyError(error);\n\n        delete deferredMap[event.id];\n        break;\n    }\n  }\n}\n\nfunction getId(): number {\n  return idCtr++;\n}\n\nexport class GrpcClient {\n  constructor() {\n    Emitter.addListener('grpc-call', handleGrpcEvent);\n  }\n  destroy() {\n    Emitter.removeAllListeners('grpc-call');\n  }\n  getHost(): Promise<string> {\n    return Grpc.getHost();\n  }\n  setHost(host: string): void {\n    Grpc.setHost(host);\n  }\n  getInsecure(): Promise<boolean> {\n    return Grpc.getIsInsecure();\n  }\n  setInsecure(insecure: boolean): void {\n    Grpc.setInsecure(insecure);\n  }\n  setResponseSizeLimit(limitInBytes: number): void {\n    Grpc.setResponseSizeLimit(limitInBytes);\n  }\n  unaryCall(\n    method: string,\n    data: Uint8Array,\n    requestHeaders?: GrpcMetadata\n  ): GrpcUnaryCall {\n    const requestData = fromByteArray(data);\n    const obj: GrpcRequestObject = {\n      data: requestData,\n    };\n\n    const id = getId();\n    const abort = new AbortController();\n\n    abort.signal.addEventListener('abort', () => {\n      Grpc.cancelGrpcCall(id);\n    });\n\n    const response = createDeferred<Uint8Array>(abort.signal);\n    const headers = createDeferred<GrpcMetadata>(abort.signal);\n    const trailers = createDeferred<GrpcMetadata>(abort.signal);\n\n    deferredMap[id] = {\n      response,\n      headers,\n      trailers,\n    };\n\n    Grpc.unaryCall(id, method, obj, requestHeaders || {});\n\n    const call = new GrpcUnaryCall(\n      method,\n      data,\n      requestHeaders || {},\n      headers.promise,\n      response.promise,\n      trailers.promise,\n      abort\n    );\n\n    call.then(\n      (result) => result,\n      () => abort.abort()\n    );\n\n    return call;\n  }\n  serverStreamCall(\n    method: string,\n    data: Uint8Array,\n    requestHeaders?: GrpcMetadata\n  ): GrpcServerStreamingCall {\n    const requestData = fromByteArray(data);\n    const obj: GrpcRequestObject = {\n      data: requestData,\n    };\n\n    const id = getId();\n    const abort = new AbortController();\n\n    abort.signal.addEventListener('abort', () => {\n      Grpc.cancelGrpcCall(id);\n    });\n\n    const headers = createDeferred<GrpcMetadata>(abort.signal);\n    const trailers = createDeferred<GrpcMetadata>(abort.signal);\n\n    const stream = new ServerOutputStream();\n\n    deferredMap[id] = {\n      headers,\n      trailers,\n      data: stream,\n    };\n\n    Grpc.serverStreamingCall(id, method, obj, requestHeaders || {});\n\n    const call = new GrpcServerStreamingCall(\n      method,\n      data,\n      requestHeaders || {},\n      headers.promise,\n      stream,\n      trailers.promise,\n      abort\n    );\n\n    call.then(\n      (result) => result,\n      () => abort.abort()\n    );\n\n    return call;\n  }\n}\n\nexport { Grpc };\n"]}