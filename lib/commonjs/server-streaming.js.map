{"version":3,"sources":["server-streaming.ts"],"names":["GrpcServerStreamingCall","constructor","method","data","requestHeaders","headers","responses","trailers","abort","request","then","onfulfilled","onrejected","completedPromise","value","Promise","resolve","reason","reject","cancel","all","status","ServerOutputStream","EventEmitter","on","event","callback","addListener","removeListener","notifyData","emit","notifyComplete","noitfyError"],"mappings":";;;;;;;AAEA;;;;;;;;;;AASA;AAEO,MAAMA,uBAAN,CAC8C;AAUnDC,EAAAA,WAAW,CACTC,MADS,EAETC,IAFS,EAGTC,cAHS,EAITC,OAJS,EAKTC,SALS,EAMTC,QANS,EAOTC,KAPS,EAQT;AAAA;;AAAA;;AAAA;;AAAA;;AAAA;;AAAA;;AAAA;AAAA;AAAA;AAAA;;AACA,SAAKN,MAAL,GAAcA,MAAd;AACA,SAAKO,OAAL,GAAeN,IAAf;AACA,SAAKC,cAAL,GAAsBA,cAAtB;AACA,SAAKC,OAAL,GAAeA,OAAf;AACA,SAAKC,SAAL,GAAiBA,SAAjB;AACA,SAAKC,QAAL,GAAgBA,QAAhB;;AACA,wCAAcC,KAAd;AACD;;AACDE,EAAAA,IAAI,CACFC,WADE,EAMFC,UANE,EAOgC;AAClC,WAAO,KAAKC,gBAAL,GAAwBH,IAAxB,CACJI,KAAD,IACEH,WAAW,GACPI,OAAO,CAACC,OAAR,CAAgBL,WAAW,CAACG,KAAD,CAA3B,CADO,GAELA,KAJH,EAKJG,MAAD,IACEL,UAAU,GACNG,OAAO,CAACC,OAAR,CAAgBJ,UAAU,CAACK,MAAD,CAA1B,CADM,GAENF,OAAO,CAACG,MAAR,CAAeD,MAAf,CARD,CAAP;AAUD;;AAEDE,EAAAA,MAAM,GAAG;AACP,wCAAYX,KAAZ;AACD;;AAED,QAAcK,gBAAd,GAAsE;AACpE,UAAM,CAACR,OAAD,EAAUE,QAAV,IAAsB,MAAMQ,OAAO,CAACK,GAAR,CAAY,CAC5C,KAAKf,OADuC,EAE5C,KAAKE,QAFuC,CAAZ,CAAlC;AAKA,WAAO;AACLL,MAAAA,MAAM,EAAE,KAAKA,MADR;AAELE,MAAAA,cAAc,EAAE,KAAKA,cAFhB;AAGLK,MAAAA,OAAO,EAAE,KAAKA,OAHT;AAILJ,MAAAA,OAJK;AAKLE,MAAAA,QALK;AAMLc,MAAAA,MAAM,EAAE;AANH,KAAP;AAQD;;AAjEkD;;;;;;AAoE9C,MAAMC,kBAAN,CAA2D;AAAA;AAAA;AAAA;AAAA,aACrD,IAAIC,0BAAJ;AADqD;AAAA;;AAGhEC,EAAAA,EAAE,CAA8BC,KAA9B,EAAwCC,QAAxC,EAAgF;AAChF,0CAAcC,WAAd,CAA0BF,KAA1B,EAAiCC,QAAjC;;AAEA,WAAO,MAAM;AACX,4CAAcE,cAAd,CAA6BH,KAA7B,EAAoCC,QAApC;AACD,KAFD;AAGD;;AAEDG,EAAAA,UAAU,CAAC1B,IAAD,EAAyB;AACjC,0CAAc2B,IAAd,CAAmB,MAAnB,EAA2B3B,IAA3B;AACD;;AAED4B,EAAAA,cAAc,GAAS;AACrB,0CAAcD,IAAd,CAAmB,UAAnB;AACD;;AAEDE,EAAAA,WAAW,CAACf,MAAD,EAAoB;AAC7B,0CAAca,IAAd,CAAmB,OAAnB,EAA4Bb,MAA5B;AACD;;AArB+D","sourcesContent":["/* eslint-disable eslint-comments/no-unlimited-disable */\nimport { AbortController } from 'abort-controller';\nimport { EventEmitter } from 'eventemitter3';\nimport {\n  CompletedGrpcStreamingCall,\n  GrpcMetadata,\n  GrpcServerOutputStream,\n  ServerOutputEvent,\n  ServerOutputEventCallback,\n} from './types';\n\n/* eslint-disable */\n\nexport class GrpcServerStreamingCall\n  implements PromiseLike<CompletedGrpcStreamingCall> {\n  readonly method: string;\n  readonly requestHeaders: GrpcMetadata;\n  readonly request: Uint8Array;\n  readonly headers: Promise<GrpcMetadata>;\n  readonly responses: GrpcServerOutputStream;\n  readonly trailers: Promise<GrpcMetadata>;\n\n  #abort: AbortController;\n\n  constructor(\n    method: string,\n    data: Uint8Array,\n    requestHeaders: GrpcMetadata,\n    headers: Promise<GrpcMetadata>,\n    responses: ServerOutputStream,\n    trailers: Promise<GrpcMetadata>,\n    abort: AbortController,\n  ) {\n    this.method = method;\n    this.request = data;\n    this.requestHeaders = requestHeaders;\n    this.headers = headers;\n    this.responses = responses;\n    this.trailers = trailers;\n    this.#abort = abort;\n  }\n  then<TResult1 = CompletedGrpcStreamingCall, TResult2 = unknown>(\n    onfulfilled?:\n      | ((\n        value: CompletedGrpcStreamingCall\n      ) => TResult1 | PromiseLike<TResult1>)\n      | null,\n    onrejected?: ((reason: any) => TResult2 | PromiseLike<TResult2>) | null\n  ): PromiseLike<TResult1 | TResult2> {\n    return this.completedPromise().then(\n      (value) =>\n        onfulfilled\n          ? Promise.resolve(onfulfilled(value))\n          : ((value as unknown) as TResult1),\n      (reason) =>\n        onrejected\n          ? Promise.resolve(onrejected(reason))\n          : Promise.reject(reason)\n    );\n  }\n\n  cancel() {\n    this.#abort.abort();\n  }\n\n  private async completedPromise(): Promise<CompletedGrpcStreamingCall> {\n    const [headers, trailers] = await Promise.all([\n      this.headers,\n      this.trailers,\n    ]);\n\n    return {\n      method: this.method,\n      requestHeaders: this.requestHeaders,\n      request: this.request,\n      headers,\n      trailers,\n      status: 0,\n    };\n  }\n}\n\nexport class ServerOutputStream implements GrpcServerOutputStream {\n  #emitter = new EventEmitter<ServerOutputEvent>();\n\n  on<T extends ServerOutputEvent>(event: T, callback: ServerOutputEventCallback<T>) {\n    this.#emitter.addListener(event, callback);\n\n    return () => {\n      this.#emitter.removeListener(event, callback);\n    }\n  }\n\n  notifyData(data: Uint8Array): void {\n    this.#emitter.emit('data', data);\n  }\n\n  notifyComplete(): void {\n    this.#emitter.emit('complete')\n  }\n\n  noitfyError(reason: any): void {\n    this.#emitter.emit('error', reason);\n  }\n}\n"]}