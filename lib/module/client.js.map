{"version":3,"sources":["client.ts"],"names":["AbortController","fromByteArray","toByteArray","NativeEventEmitter","NativeModules","GrpcError","GrpcServerStreamingCall","ServerOutputStream","GrpcUnaryCall","Grpc","Emitter","createDeferred","signal","completed","deferred","promise","Promise","resolve","reject","value","reason","addEventListener","idCtr","deferredMap","handleGrpcEvent","event","id","type","headers","payload","data","notifyData","response","trailers","notifyComplete","error","code","noitfyError","getId","GrpcClient","constructor","addListener","destroy","removeAllListeners","getHost","setHost","host","getInsecure","getIsInsecure","setInsecure","insecure","setResponseSizeLimit","limitInBytes","unaryCall","method","requestHeaders","requestData","obj","abort","cancelGrpcCall","call","then","result","serverStreamCall","stream","serverStreamingCall"],"mappings":"AAAA,SAASA,eAAT,QAA6C,kBAA7C;AACA,SAASC,aAAT,EAAwBC,WAAxB,QAA2C,WAA3C;AACA,SAASC,kBAAT,EAA6BC,aAA7B,QAAkD,cAAlD;AACA,SAASC,SAAT,QAA0B,UAA1B;AACA,SACEC,uBADF,EAEEC,kBAFF,QAGO,oBAHP;AAKA,SAASC,aAAT,QAA8B,SAA9B;AA8DA,MAAM;AAAEC,EAAAA;AAAF,IAAWL,aAAjB;AAEA,MAAMM,OAAO,GAAG,IAAIP,kBAAJ,CAAuBC,aAAa,CAACK,IAArC,CAAhB;;AAmBA,SAASE,cAAT,CAA2BC,MAA3B,EAAgD;AAC9C,MAAIC,SAAS,GAAG,KAAhB;AAEA,QAAMC,QAAqB,GAAG,EAA9B;AAEAA,EAAAA,QAAQ,CAACC,OAAT,GAAmB,IAAIC,OAAJ,CAAe,CAACC,OAAD,EAAUC,MAAV,KAAqB;AACrDJ,IAAAA,QAAQ,CAACG,OAAT,GAAoBE,KAAD,IAAW;AAC5BN,MAAAA,SAAS,GAAG,IAAZ;AAEAI,MAAAA,OAAO,CAACE,KAAD,CAAP;AACD,KAJD;;AAKAL,IAAAA,QAAQ,CAACI,MAAT,GAAmBE,MAAD,IAAY;AAC5BP,MAAAA,SAAS,GAAG,IAAZ;AAEAK,MAAAA,MAAM,CAACE,MAAD,CAAN;AACD,KAJD;AAKD,GAXkB,CAAnB;AAaAR,EAAAA,MAAM,CAACS,gBAAP,CAAwB,OAAxB,EAAiC,MAAM;AACrC,QAAI,CAACR,SAAL,EAAgB;AACdC,MAAAA,QAAQ,CAACI,MAAT,CAAgB,SAAhB;AACD;AACF,GAJD;AAMA,SAAOJ,QAAP;AACD;;AAED,IAAIQ,KAAK,GAAG,CAAZ;AAEA,MAAMC,WAA4B,GAAG,EAArC;;AAEA,SAASC,eAAT,CAAyBC,KAAzB,EAA2C;AAAA;;AACzC,QAAMX,QAAQ,GAAGS,WAAW,CAACE,KAAK,CAACC,EAAP,CAA5B;;AAEA,MAAIZ,QAAJ,EAAc;AACZ,YAAQW,KAAK,CAACE,IAAd;AACE,WAAK,SAAL;AACE,6BAAAb,QAAQ,CAACc,OAAT,wEAAkBX,OAAlB,CAA0BQ,KAAK,CAACI,OAAhC;AACA;;AACF,WAAK,UAAL;AACE,cAAMC,IAAI,GAAG5B,WAAW,CAACuB,KAAK,CAACI,OAAP,CAAxB;AAEA,0BAAAf,QAAQ,CAACgB,IAAT,kEAAeC,UAAf,CAA0BD,IAA1B;AACA,8BAAAhB,QAAQ,CAACkB,QAAT,0EAAmBf,OAAnB,CAA2Ba,IAA3B;AACA;;AACF,WAAK,UAAL;AACE,8BAAAhB,QAAQ,CAACmB,QAAT,0EAAmBhB,OAAnB,CAA2BQ,KAAK,CAACI,OAAjC;AACA,2BAAAf,QAAQ,CAACgB,IAAT,oEAAeI,cAAf;AAEA,eAAOX,WAAW,CAACE,KAAK,CAACC,EAAP,CAAlB;AACA;;AACF,WAAK,OAAL;AACE,cAAMS,KAAK,GAAG,IAAI9B,SAAJ,CAAcoB,KAAK,CAACU,KAApB,EAA2BV,KAAK,CAACW,IAAjC,EAAuCX,KAAK,CAACQ,QAA7C,CAAd;AAEA,8BAAAnB,QAAQ,CAACc,OAAT,0EAAkBV,MAAlB,CAAyBiB,KAAzB;AACA,+BAAArB,QAAQ,CAACmB,QAAT,4EAAmBf,MAAnB,CAA0BiB,KAA1B;AACA,+BAAArB,QAAQ,CAACkB,QAAT,4EAAmBd,MAAnB,CAA0BiB,KAA1B;AACA,2BAAArB,QAAQ,CAACgB,IAAT,oEAAeO,WAAf,CAA2BF,KAA3B;AAEA,eAAOZ,WAAW,CAACE,KAAK,CAACC,EAAP,CAAlB;AACA;AAzBJ;AA2BD;AACF;;AAED,SAASY,KAAT,GAAyB;AACvB,SAAOhB,KAAK,EAAZ;AACD;;AAED,OAAO,MAAMiB,UAAN,CAAiB;AACtBC,EAAAA,WAAW,GAAG;AACZ9B,IAAAA,OAAO,CAAC+B,WAAR,CAAoB,WAApB,EAAiCjB,eAAjC;AACD;;AACDkB,EAAAA,OAAO,GAAG;AACRhC,IAAAA,OAAO,CAACiC,kBAAR,CAA2B,WAA3B;AACD;;AACDC,EAAAA,OAAO,GAAoB;AACzB,WAAOnC,IAAI,CAACmC,OAAL,EAAP;AACD;;AACDC,EAAAA,OAAO,CAACC,IAAD,EAAqB;AAC1BrC,IAAAA,IAAI,CAACoC,OAAL,CAAaC,IAAb;AACD;;AACDC,EAAAA,WAAW,GAAqB;AAC9B,WAAOtC,IAAI,CAACuC,aAAL,EAAP;AACD;;AACDC,EAAAA,WAAW,CAACC,QAAD,EAA0B;AACnCzC,IAAAA,IAAI,CAACwC,WAAL,CAAiBC,QAAjB;AACD;;AACDC,EAAAA,oBAAoB,CAACC,YAAD,EAA6B;AAC/C3C,IAAAA,IAAI,CAAC0C,oBAAL,CAA0BC,YAA1B;AACD;;AACDC,EAAAA,SAAS,CACPC,MADO,EAEPxB,IAFO,EAGPyB,cAHO,EAIQ;AACf,UAAMC,WAAW,GAAGvD,aAAa,CAAC6B,IAAD,CAAjC;AACA,UAAM2B,GAAsB,GAAG;AAC7B3B,MAAAA,IAAI,EAAE0B;AADuB,KAA/B;AAIA,UAAM9B,EAAE,GAAGY,KAAK,EAAhB;AACA,UAAMoB,KAAK,GAAG,IAAI1D,eAAJ,EAAd;AAEA0D,IAAAA,KAAK,CAAC9C,MAAN,CAAaS,gBAAb,CAA8B,OAA9B,EAAuC,MAAM;AAC3CZ,MAAAA,IAAI,CAACkD,cAAL,CAAoBjC,EAApB;AACD,KAFD;AAIA,UAAMM,QAAQ,GAAGrB,cAAc,CAAa+C,KAAK,CAAC9C,MAAnB,CAA/B;AACA,UAAMgB,OAAO,GAAGjB,cAAc,CAAe+C,KAAK,CAAC9C,MAArB,CAA9B;AACA,UAAMqB,QAAQ,GAAGtB,cAAc,CAAe+C,KAAK,CAAC9C,MAArB,CAA/B;AAEAW,IAAAA,WAAW,CAACG,EAAD,CAAX,GAAkB;AAChBM,MAAAA,QADgB;AAEhBJ,MAAAA,OAFgB;AAGhBK,MAAAA;AAHgB,KAAlB;AAMAxB,IAAAA,IAAI,CAAC4C,SAAL,CAAe3B,EAAf,EAAmB4B,MAAnB,EAA2BG,GAA3B,EAAgCF,cAAc,IAAI,EAAlD;AAEA,UAAMK,IAAI,GAAG,IAAIpD,aAAJ,CACX8C,MADW,EAEXxB,IAFW,EAGXyB,cAAc,IAAI,EAHP,EAIX3B,OAAO,CAACb,OAJG,EAKXiB,QAAQ,CAACjB,OALE,EAMXkB,QAAQ,CAAClB,OANE,EAOX2C,KAPW,CAAb;AAUAE,IAAAA,IAAI,CAACC,IAAL,CACGC,MAAD,IAAYA,MADd,EAEE,MAAMJ,KAAK,CAACA,KAAN,EAFR;AAKA,WAAOE,IAAP;AACD;;AACDG,EAAAA,gBAAgB,CACdT,MADc,EAEdxB,IAFc,EAGdyB,cAHc,EAIW;AACzB,UAAMC,WAAW,GAAGvD,aAAa,CAAC6B,IAAD,CAAjC;AACA,UAAM2B,GAAsB,GAAG;AAC7B3B,MAAAA,IAAI,EAAE0B;AADuB,KAA/B;AAIA,UAAM9B,EAAE,GAAGY,KAAK,EAAhB;AACA,UAAMoB,KAAK,GAAG,IAAI1D,eAAJ,EAAd;AAEA0D,IAAAA,KAAK,CAAC9C,MAAN,CAAaS,gBAAb,CAA8B,OAA9B,EAAuC,MAAM;AAC3CZ,MAAAA,IAAI,CAACkD,cAAL,CAAoBjC,EAApB;AACD,KAFD;AAIA,UAAME,OAAO,GAAGjB,cAAc,CAAe+C,KAAK,CAAC9C,MAArB,CAA9B;AACA,UAAMqB,QAAQ,GAAGtB,cAAc,CAAe+C,KAAK,CAAC9C,MAArB,CAA/B;AAEA,UAAMoD,MAAM,GAAG,IAAIzD,kBAAJ,EAAf;AAEAgB,IAAAA,WAAW,CAACG,EAAD,CAAX,GAAkB;AAChBE,MAAAA,OADgB;AAEhBK,MAAAA,QAFgB;AAGhBH,MAAAA,IAAI,EAAEkC;AAHU,KAAlB;AAMAvD,IAAAA,IAAI,CAACwD,mBAAL,CAAyBvC,EAAzB,EAA6B4B,MAA7B,EAAqCG,GAArC,EAA0CF,cAAc,IAAI,EAA5D;AAEA,UAAMK,IAAI,GAAG,IAAItD,uBAAJ,CACXgD,MADW,EAEXxB,IAFW,EAGXyB,cAAc,IAAI,EAHP,EAIX3B,OAAO,CAACb,OAJG,EAKXiD,MALW,EAMX/B,QAAQ,CAAClB,OANE,EAOX2C,KAPW,CAAb;AAUAE,IAAAA,IAAI,CAACC,IAAL,CACGC,MAAD,IAAYA,MADd,EAEE,MAAMJ,KAAK,CAACA,KAAN,EAFR;AAKA,WAAOE,IAAP;AACD;;AAlHqB;AAqHxB,SAASnD,IAAT","sourcesContent":["import { AbortController, AbortSignal } from 'abort-controller';\nimport { fromByteArray, toByteArray } from 'base64-js';\nimport { NativeEventEmitter, NativeModules } from 'react-native';\nimport { GrpcError } from './errors';\nimport {\n  GrpcServerStreamingCall,\n  ServerOutputStream,\n} from './server-streaming';\nimport { GrpcMetadata } from './types';\nimport { GrpcUnaryCall } from './unary';\n\ntype GrpcRequestObject = {\n  data: string;\n};\n\ntype GrpcType = {\n  getHost: () => Promise<string>;\n  getIsInsecure: () => Promise<boolean>;\n  setHost(host: string): void;\n  setInsecure(insecure: boolean): void;\n  setResponseSizeLimit(limitInBytes: number): void;\n  unaryCall(\n    id: number,\n    path: string,\n    obj: GrpcRequestObject,\n    requestHeaders?: GrpcMetadata\n  ): Promise<void>;\n  serverStreamingCall(\n    id: number,\n    path: string,\n    obj: GrpcRequestObject,\n    requestHeaders?: GrpcMetadata\n  ): Promise<void>;\n  cancelGrpcCall: (id: number) => Promise<boolean>;\n  clientStreamingCall(\n    id: number,\n    path: string,\n    obj: GrpcRequestObject,\n    requestHeaders?: GrpcMetadata\n  ): Promise<void>;\n  finishClientStreaming(id: number): Promise<void>;\n};\n\ntype GrpcEventType = 'response' | 'error' | 'headers' | 'trailers';\n\n/* prettier-ignore */\ntype GrpcEventPayload =\n  {\n    type: 'response';\n    payload: string;\n  } | {\n    type: 'error';\n    error: string;\n    code?: number;\n    trailers?: GrpcMetadata;\n  } | {\n    type: 'headers';\n    payload: GrpcMetadata;\n  } | {\n    type: 'trailers';\n    payload: GrpcMetadata;\n  } | {\n    type: 'status';\n    payload: number;\n  };\n\ntype GrpcEvent = {\n  id: number;\n  type: GrpcEventType;\n} & GrpcEventPayload;\n\nconst { Grpc } = NativeModules as { Grpc: GrpcType };\n\nconst Emitter = new NativeEventEmitter(NativeModules.Grpc);\n\ntype Deferred<T> = {\n  promise: Promise<T>;\n  resolve: (value: T) => void;\n  reject: (reason: any) => void;\n};\n\ntype DeferredCalls = {\n  headers?: Deferred<GrpcMetadata>;\n  response?: Deferred<Uint8Array>;\n  trailers?: Deferred<GrpcMetadata>;\n  data?: ServerOutputStream;\n};\n\ntype DeferredCallMap = {\n  [id: number]: DeferredCalls;\n};\n\nfunction createDeferred<T>(signal: AbortSignal) {\n  let completed = false;\n\n  const deferred: Deferred<T> = {} as any;\n\n  deferred.promise = new Promise<T>((resolve, reject) => {\n    deferred.resolve = (value) => {\n      completed = true;\n\n      resolve(value);\n    };\n    deferred.reject = (reason) => {\n      completed = true;\n\n      reject(reason);\n    };\n  });\n\n  signal.addEventListener('abort', () => {\n    if (!completed) {\n      deferred.reject('aborted');\n    }\n  });\n\n  return deferred;\n}\n\nlet idCtr = 1;\n\nconst deferredMap: DeferredCallMap = {};\n\nfunction handleGrpcEvent(event: GrpcEvent) {\n  const deferred = deferredMap[event.id];\n\n  if (deferred) {\n    switch (event.type) {\n      case 'headers':\n        deferred.headers?.resolve(event.payload);\n        break;\n      case 'response':\n        const data = toByteArray(event.payload);\n\n        deferred.data?.notifyData(data);\n        deferred.response?.resolve(data);\n        break;\n      case 'trailers':\n        deferred.trailers?.resolve(event.payload);\n        deferred.data?.notifyComplete();\n\n        delete deferredMap[event.id];\n        break;\n      case 'error':\n        const error = new GrpcError(event.error, event.code, event.trailers);\n\n        deferred.headers?.reject(error);\n        deferred.trailers?.reject(error);\n        deferred.response?.reject(error);\n        deferred.data?.noitfyError(error);\n\n        delete deferredMap[event.id];\n        break;\n    }\n  }\n}\n\nfunction getId(): number {\n  return idCtr++;\n}\n\nexport class GrpcClient {\n  constructor() {\n    Emitter.addListener('grpc-call', handleGrpcEvent);\n  }\n  destroy() {\n    Emitter.removeAllListeners('grpc-call');\n  }\n  getHost(): Promise<string> {\n    return Grpc.getHost();\n  }\n  setHost(host: string): void {\n    Grpc.setHost(host);\n  }\n  getInsecure(): Promise<boolean> {\n    return Grpc.getIsInsecure();\n  }\n  setInsecure(insecure: boolean): void {\n    Grpc.setInsecure(insecure);\n  }\n  setResponseSizeLimit(limitInBytes: number): void {\n    Grpc.setResponseSizeLimit(limitInBytes);\n  }\n  unaryCall(\n    method: string,\n    data: Uint8Array,\n    requestHeaders?: GrpcMetadata\n  ): GrpcUnaryCall {\n    const requestData = fromByteArray(data);\n    const obj: GrpcRequestObject = {\n      data: requestData,\n    };\n\n    const id = getId();\n    const abort = new AbortController();\n\n    abort.signal.addEventListener('abort', () => {\n      Grpc.cancelGrpcCall(id);\n    });\n\n    const response = createDeferred<Uint8Array>(abort.signal);\n    const headers = createDeferred<GrpcMetadata>(abort.signal);\n    const trailers = createDeferred<GrpcMetadata>(abort.signal);\n\n    deferredMap[id] = {\n      response,\n      headers,\n      trailers,\n    };\n\n    Grpc.unaryCall(id, method, obj, requestHeaders || {});\n\n    const call = new GrpcUnaryCall(\n      method,\n      data,\n      requestHeaders || {},\n      headers.promise,\n      response.promise,\n      trailers.promise,\n      abort\n    );\n\n    call.then(\n      (result) => result,\n      () => abort.abort()\n    );\n\n    return call;\n  }\n  serverStreamCall(\n    method: string,\n    data: Uint8Array,\n    requestHeaders?: GrpcMetadata\n  ): GrpcServerStreamingCall {\n    const requestData = fromByteArray(data);\n    const obj: GrpcRequestObject = {\n      data: requestData,\n    };\n\n    const id = getId();\n    const abort = new AbortController();\n\n    abort.signal.addEventListener('abort', () => {\n      Grpc.cancelGrpcCall(id);\n    });\n\n    const headers = createDeferred<GrpcMetadata>(abort.signal);\n    const trailers = createDeferred<GrpcMetadata>(abort.signal);\n\n    const stream = new ServerOutputStream();\n\n    deferredMap[id] = {\n      headers,\n      trailers,\n      data: stream,\n    };\n\n    Grpc.serverStreamingCall(id, method, obj, requestHeaders || {});\n\n    const call = new GrpcServerStreamingCall(\n      method,\n      data,\n      requestHeaders || {},\n      headers.promise,\n      stream,\n      trailers.promise,\n      abort\n    );\n\n    call.then(\n      (result) => result,\n      () => abort.abort()\n    );\n\n    return call;\n  }\n}\n\nexport { Grpc };\n"]}